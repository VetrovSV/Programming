# Обработка исключительных ситуаций

## Бросок и перехват исключения

**Исключительная ситуация** — ситуация, при которой выполнение программы (чаще функции или метода) по основному алгоритму невозможно. Это может случаться из‑за непредвиденных ошибок: например, когда не удаётся открыть нужный файл, отправить сообщение по сети, закончилась память или функция не может быть выполнена из‑за некорректных аргументов.

Как правило, в процедурно‑модульном программировании и ООП исключения возникают в функциях и методах, поскольку весь код состоит из вызовов функций и методов. Нередко в самой функции нельзя корректно отреагировать на исключительную ситуацию без нарушения *принципа единственной ответственности*. Например, если в функцию вычисления среднего значения передано 0 элементов, нежелательно, чтобы функция сама выводила сообщение на экран, писала в лог или показывала окно с ошибкой. Реагировать на возникшую исключительную ситуацию должен код, который вызывал эту функцию — на этом уровне обычно понятно, как поступить правильно.

Для того чтобы сообщить вызывающему коду о возникновении исключительной ситуации, используется оператор `raise`. Как правило, используется вызов такого вида: `raise ExceptionType("message")`, где `ExceptionType("message")` — создание экземпляра исключения с описанием ситуации.

Для обозначения таких ситуаций обычно применяются специальные типы — `Exception` или его производные.

Вызывающий код, в свою очередь, использует конструкцию следующего вида, чтобы отловить исключение:

```python
try:                             
    # блок кода, где может возникнуть исключительная ситуация
    do_something()

except Exception as e:         
    # обработчик исключительной ситуации.
    # Будет вызван, если возникло исключение в try.
    # В переменную e будет записан экземпляр исключения.
    print("Во время выполнения возникла ошибка: " + str(e))
```

## Часто используемые встроенные типы исключений (русский — английский)

* `ValueError` — неверное значение (например, некорректный формат числа).
* `TypeError` — неверный тип аргумента.
* `KeyError` — отсутствующий ключ в `dict`.
* `IndexError` — выход за границы списка/последовательности.
* `FileNotFoundError` — файл не найден (подтип `OSError`).
* `PermissionError` — недостаточно прав доступа.
* `IOError` / `OSError` — ошибки ввода‑вывода / операционной системы.
* `RuntimeError` — общая ошибка времени выполнения.
* `NotImplementedError` — метод не реализован.
* `StopIteration` — окончание итерации.
* `AssertionError` — сработал `assert`.
  (англ. в скобках: `ValueError`, `TypeError`, … — совпадают)

---

## Пример: проверка значений аргументов — предусловия функции

* Если функция получила неправильный тип → `TypeError`.
* Неподходящее значение (например, отрицательное число там, где требуется положительное) → `ValueError`.

```python
def calc_hypotenuse(a: float = 3, b: float = 4) -> float:
    """
    Возвращает гипотенузу треугольника, a, b — катеты
    :param a: катет 1, a>0
    :param b: катет 2, b>0
    :return: гипотенуза

    :raise ValueError: Бросает исключение, если a <= 0 или b <= 0
    """
    if a > 0 and b > 0:
        return (a*a + b*b)**0.5
    else:
        raise ValueError("Один или несколько катетов меньше или равны нулю")
```

Описывайте, какие исключения выбрасываются, в docstring функции.

## Паттерн EAFP (Easier to Ask Forgiveness than Permission)

* **EAFP** — попытаться выполнить операцию и обработать исключение, если оно возникнет:

```python
try:
    value = d[key]
except KeyError:
    value = default
```

## Очистка: `finally`

* `finally` выполняется всегда — пригодно для освобождения ресурсов вне `with`:

```python
conn = open_conn()
try:
    use(conn)
finally:
    conn.close()
```

---

## Assert vs Exceptions

* `assert` — для внутренних проверок во время разработки.
* Для проверки пользовательского ввода **используйте исключения**, а не `assert`.

## См. также

* Полную форму оператора `try ... except ... else ... finally`
* Повторное пробрасывание и подавление
* Исключения в часто используемых функциях и библиотеках: открытие и чтение файла, преобразование строк в числа и т.п.
* Автоматическое логирование исключений
